<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ü Detector de Lenguaje de Se√±as</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            max-width: 1200px;
            width: 90%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .video-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
        }

        .video-placeholder {
            width: 100%;
            height: 480px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 1.5em;
            border-radius: 10px;
        }

        .controls {
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn.success {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .detection-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
        }

        .detection-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .detected-letter {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confidence {
            font-size: 2em;
            margin: 15px 0;
        }

        .status {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .status.running {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
        }

        .status.stopped {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .alphabet-letter {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .alphabet-letter.active {
            background: rgba(46, 213, 115, 0.3);
            border-color: #2ed573;
            transform: scale(1.1);
        }

        .stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stats h3 {
            margin-bottom: 10px;
            color: #ffd700;
        }

        .training-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            border: 2px solid #ffd700;
        }

        .training-section h3 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
        }

        .target-letter {
            font-size: 6em;
            font-weight: bold;
            text-align: center;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            margin: 10px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .training-info {
            text-align: center;
        }

        .training-stats {
            margin: 15px 0;
            font-size: 1.1em;
        }

        .training-stats p {
            margin: 5px 0;
        }

        .training-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .training-message.success {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
            animation: celebration 0.5s ease-in-out;
        }

        .training-message.hint {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .reference-image-container {
            margin: 20px 0;
            text-align: center;
        }

        .reference-image-container h4 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .reference-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin: 10px auto;
            max-width: 200px;
            border: 2px solid #ffd700;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        .reference-letter {
            font-size: 3em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .reference-emoji {
            font-size: 2.5em;
            margin: 10px 0;
        }

        .reference-description {
            font-size: 0.9em;
            color: #fff;
            line-height: 1.4;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .detected-letter {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ü Detector de Lenguaje de Se√±as</h1>
            <p>Tecnolog√≠a YOLO + MediaPipe para reconocimiento en tiempo real</p>
        </div>

        <div class="main-content">
            <div class="video-section">
                <h2>üìπ C√°mara en Vivo</h2>
                <div class="video-container">
                    <div class="video-placeholder" id="videoPlaceholder">
                        <span>Presiona "Iniciar Detecci√≥n" para comenzar</span>
                    </div>
                    <img id="videoFeed" style="display: none;" alt="Video Feed">
                </div>
                
                <div class="controls">
                    <button id="toggleBtn" class="btn">üé• Iniciar Detecci√≥n</button>
                    <button id="stopBtn" class="btn" style="display: none;">‚èπÔ∏è Detener</button>
                    <button id="trainingBtn" class="btn success" style="display: none;">üéì Modo Entrenamiento</button>
                    <button id="stopTrainingBtn" class="btn" style="display: none;">üèÅ Parar Entrenamiento</button>
                    <br><br>
                    <button id="testCameraBtn" class="btn" style="background: linear-gradient(45deg, #ff9a56, #ff6b6b);">üîç Probar C√°mara</button>
                    <button id="testModelBtn" class="btn" style="background: linear-gradient(45deg, #a8edea, #fed6e3);">ü§ñ Probar Modelo</button>
                </div>
            </div>

            <div class="detection-panel">
                <div class="detection-info">
                    <h2>üîç Detecci√≥n Actual</h2>
                    
                    <div class="detected-letter" id="detectedLetter">-</div>
                    
                    <div class="confidence">
                        Confianza: <span id="confidence">0</span>%
                    </div>
                    
                    <div class="status stopped" id="status">
                        ‚è∏Ô∏è DETENIDO
                    </div>
                </div>

                <div class="alphabet-grid" id="alphabetGrid">
                    <!-- Se generar√° con JavaScript -->
                </div>

                <div class="stats">
                    <h3>üìä Estad√≠sticas</h3>
                    <p>Detecciones: <span id="detectionCount">0</span></p>
                    <p>Tiempo activo: <span id="activeTime">00:00</span></p>
                    <p>FPS: <span id="fps">0</span></p>
                </div>

                <!-- Secci√≥n de Entrenamiento -->
                <div class="training-section" id="trainingSection" style="display: none;">
                    <h3>üéì Modo Entrenamiento</h3>
                    <div class="training-info">
                        <div class="target-letter" id="targetLetter">A</div>
                        <p>Haz esta letra con tu mano</p>
                        
                        <!-- Imagen de referencia -->
                        <div class="reference-image-container" id="referenceContainer">
                            <h4>üìñ Referencia:</h4>
                            <div class="reference-card" id="referenceCard">
                                <div class="reference-letter" id="referenceLetter">A</div>
                                <div class="reference-emoji" id="referenceEmoji">‚úä</div>
                                <div class="reference-description" id="referenceDescription">Pu√±o cerrado con pulgar hacia arriba</div>
                            </div>
                        </div>
                        
                        <div class="training-stats">
                            <p>Aciertos: <span id="trainingCorrect">0</span>/<span id="trainingTotal">0</span></p>
                            <p>Precisi√≥n: <span id="trainingAccuracy">0</span>%</p>
                            <p>Consecutivos: <span id="trainingConsecutive">0</span></p>
                        </div>
                        <div class="training-message" id="trainingMessage"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% load static %}
    <!-- Incluir configuraci√≥n de referencias optimizada -->
    <script src="{% static 'detector/js/reference_config.js' %}"></script>

    <script>
        // Configuraci√≥n y variables globales optimizadas
        let videoElement = document.getElementById('videoElement');
        let canvas = document.getElementById('canvas');
        let canvasContext = canvas.getContext('2d');
        let detectionActive = false;
        let detectionInterval;
        let lastKnownPrediction = '';
        let trainingMode = false;
        let targetLetter = '';
        let trainingStats = {
            correct: 0,
            incorrect: 0,
            total: 0
        };
        
        // Variables de optimizaci√≥n de rendimiento
        let frameSkipCounter = 0;
        let lastUpdateTime = 0;
        let lastKnownFrame = '';
        const updateThrottle = REFERENCE_CONFIG.ui.updateThrottle;
        const frameSkipRate = REFERENCE_CONFIG.performance.frameSkipRate;

        // Referencias optimizadas con im√°genes reales del dataset
        const letterReferences = {
            'A': { 
                image: "/static/detector/reference_images/A.jpg", 
                description: 'Pu√±o cerrado con pulgar hacia arriba' 
            },
            'B': { 
                image: "/static/detector/reference_images/B.jpg", 
                description: 'Mano abierta, dedos juntos hacia arriba' 
            },
            'C': { 
                image: "/static/detector/reference_images/C.jpg", 
                description: 'Forma de "C" con dedos curvados' 
            },
            'D': { 
                image: "/static/detector/reference_images/D.jpg", 
                description: 'Dedo √≠ndice hacia arriba, otros curvados' 
            },
            'E': { 
                image: "/static/detector/reference_images/E.jpg", 
                description: 'Pu√±o cerrado con dedos doblados' 
            },
            'F': { 
                image: "/static/detector/reference_images/F.jpg", 
                description: 'Pulgar e √≠ndice formando c√≠rculo' 
            },
            'G': { 
                image: "/static/detector/reference_images/G.jpg", 
                description: 'Dedo √≠ndice apuntando horizontalmente' 
            },
            'H': { 
                image: "/static/detector/reference_images/H.jpg", 
                description: 'Dos dedos extendidos horizontalmente' 
            },
            'I': { 
                image: "/static/detector/reference_images/I.jpg", 
                description: 'Me√±ique extendido hacia arriba' 
            },
            'J': { 
                image: "/static/detector/reference_images/J.jpg", 
                description: 'Me√±ique con movimiento' 
            },
            'K': { 
                image: "/static/detector/reference_images/K.jpg", 
                description: '√çndice y medio en V con pulgar' 
            },
            'L': { 
                image: "/static/detector/reference_images/L.jpg", 
                description: 'L con √≠ndice y pulgar' 
            },
            'M': { 
                image: "/static/detector/reference_images/M.jpg", 
                description: 'Pu√±o con tres dedos sobre pulgar' 
            },
            'N': { 
                image: "/static/detector/reference_images/N.jpg", 
                description: 'Pu√±o con dos dedos sobre pulgar' 
            },
            'O': { 
                image: "/static/detector/reference_images/O.jpg", 
                description: 'C√≠rculo con todos los dedos' 
            },
            'P': { 
                image: "/static/detector/reference_images/P.jpg", 
                description: 'Como K pero hacia abajo' 
            },
            'Q': { 
                image: "/static/detector/reference_images/Q.jpg", 
                description: 'Como G pero hacia abajo' 
            },
            'R': { 
                image: "/static/detector/reference_images/R.jpg", 
                description: '√çndice y medio cruzados' 
            },
            'S': { 
                image: "/static/detector/reference_images/S.jpg", 
                description: 'Pu√±o cerrado simple' 
            },
            'T': { 
                image: "/static/detector/reference_images/T.jpg", 
                description: 'Pu√±o con pulgar entre √≠ndice y medio' 
            },
            'U': { 
                image: "/static/detector/reference_images/U.jpg", 
                description: 'Dos dedos juntos hacia arriba' 
            },
            'V': { 
                image: "/static/detector/reference_images/V.jpg", 
                description: 'Dos dedos en V separados' 
            },
            'W': { 
                image: "/static/detector/reference_images/W.jpg", 
                description: 'Tres dedos extendidos' 
            },
            'X': { 
                image: "/static/detector/reference_images/X.jpg", 
                description: 'Dedo √≠ndice curvado' 
            },
            'Y': { 
                image: "/static/detector/reference_images/Y.jpg", 
                description: 'Pulgar y me√±ique extendidos' 
            },
            'Z': { 
                image: "/static/detector/reference_images/Z.jpg", 
                description: 'Dedo √≠ndice haciendo zigzag' 
            }
        };

        // Variables globales
        let isDetecting = false;
        let isTraining = false;
        let startTime = null;
        let detectionCount = 0;
        let fpsCounter = 0;

        // Elementos DOM
        const toggleBtn = document.getElementById('toggleBtn');
        const stopBtn = document.getElementById('stopBtn');
        const trainingBtn = document.getElementById('trainingBtn');
        const stopTrainingBtn = document.getElementById('stopTrainingBtn');
        const testCameraBtn = document.getElementById('testCameraBtn');
        const testModelBtn = document.getElementById('testModelBtn');
        const trainingSection = document.getElementById('trainingSection');
        let targetLetterEl = document.getElementById('targetLetter');
        const trainingMessage = document.getElementById('trainingMessage');
        const trainingCorrect = document.getElementById('trainingCorrect');
        const trainingTotal = document.getElementById('trainingTotal');
        const trainingAccuracy = document.getElementById('trainingAccuracy');
        const trainingConsecutive = document.getElementById('trainingConsecutive');
        const videoFeed = document.getElementById('videoFeed');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const detectedLetter = document.getElementById('detectedLetter');
        const confidence = document.getElementById('confidence');
        const status = document.getElementById('status');
        const alphabetGrid = document.getElementById('alphabetGrid');
        const detectionCountEl = document.getElementById('detectionCount');
        const activeTimeEl = document.getElementById('activeTime');
        const fpsEl = document.getElementById('fps');
        
        // Elementos de referencia
        const referenceLetter = document.getElementById('referenceLetter');
        const referenceEmoji = document.getElementById('referenceEmoji');
        const referenceDescription = document.getElementById('referenceDescription');

        // Funci√≥n optimizada para actualizar imagen de referencia
        function updateReferenceImage(letter) {
            if (letterReferences[letter]) {
                referenceLetter.textContent = letter;
                
                // Usar imagen real del dataset en lugar de emoji
                if (letterReferences[letter].image) {
                    // Crear elemento de imagen si no existe
                    let referenceImage = document.getElementById('referenceImage');
                    if (!referenceImage) {
                        referenceImage = document.createElement('img');
                        referenceImage.id = 'referenceImage';
                        referenceImage.style.cssText = `
                            width: 100px;
                            height: 100px;
                            object-fit: cover;
                            border-radius: 10px;
                            border: 2px solid rgba(255,255,255,0.3);
                            margin: 10px 0;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                        `;
                        // Reemplazar el emoji con la imagen
                        referenceEmoji.style.display = 'none';
                        referenceEmoji.parentNode.insertBefore(referenceImage, referenceEmoji);
                    }
                    
                    // Cargar imagen con cach√© optimizado
                    const cachedImg = imageCache.get(letter);
                    if (cachedImg) {
                        referenceImage.src = cachedImg.src;
                    } else {
                        referenceImage.src = letterReferences[letter].image;
                        // Agregar al cach√© cuando se cargue
                        referenceImage.onload = () => {
                            imageCache.set(letter, referenceImage.cloneNode());
                        };
                    }
                    
                    referenceImage.alt = `Se√±a para la letra ${letter}`;
                } else {
                    // Fallback a emoji si no hay imagen
                    referenceEmoji.style.display = 'block';
                    referenceEmoji.textContent = letterReferences[letter].emoji || 'ü§ü';
                }
                
                referenceDescription.textContent = letterReferences[letter].description;
            }
        }

        // Crear grid del alfabeto
        function createAlphabetGrid() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            alphabetGrid.innerHTML = '';
            letters.forEach(letter => {
                const div = document.createElement('div');
                div.className = 'alphabet-letter';
                div.textContent = letter;
                div.id = `letter-${letter}`;
                alphabetGrid.appendChild(div);
            });
        }

        // Actualizar letra activa
        function updateActiveLetter(letter) {
            document.querySelectorAll('.alphabet-letter').forEach(el => {
                el.classList.remove('active');
            });
            
            if (letter && letter !== 'NINGUNA') {
                const letterEl = document.getElementById(`letter-${letter}`);
                if (letterEl) {
                    letterEl.classList.add('active');
                }
            }
        }

        // Actualizar tiempo activo
        function updateActiveTime() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                activeTimeEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Iniciar detecci√≥n
        async function startDetection() {
            try {
                toggleBtn.disabled = true;
                toggleBtn.textContent = 'üé• Iniciando...';
                
                const response = await fetch('/start/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    isDetecting = true;
                    startTime = Date.now();
                    
                    toggleBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    trainingBtn.style.display = 'inline-block';
                    
                    videoPlaceholder.style.display = 'none';
                    videoFeed.style.display = 'block';
                    
                    status.textContent = 'üü¢ DETECTANDO';
                    status.className = 'status running';
                    
                    // Iniciar actualizaci√≥n de datos
                    detectionInterval = setInterval(updateDetection, 50); // 20 FPS
                    
                    // Actualizar tiempo cada segundo
                    setInterval(updateActiveTime, 1000);
                    
                } else {
                    alert('‚ùå Error al iniciar detecci√≥n: ' + data.message + '\n\nSugerencias:\n- Verifica que tu c√°mara est√© conectada\n- Cierra otras aplicaciones que usen la c√°mara\n- Prueba con el bot√≥n "Probar C√°mara"');
                    toggleBtn.disabled = false;
                    toggleBtn.textContent = 'üé• Iniciar Detecci√≥n';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message + '\n\nVerifica que el servidor Django est√© ejecut√°ndose.');
                toggleBtn.disabled = false;
                toggleBtn.textContent = 'üé• Iniciar Detecci√≥n';
            }
        }

        // Detener detecci√≥n
        async function stopDetection() {
            try {
                const response = await fetch('/stop/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    isDetecting = false;
                    startTime = null;
                    
                    // Detener entrenamiento si est√° activo
                    if (isTraining) {
                        await stopTraining();
                    }
                    
                    toggleBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    trainingBtn.style.display = 'none';
                    stopTrainingBtn.style.display = 'none';
                    trainingSection.style.display = 'none';
                    
                    videoFeed.style.display = 'none';
                    videoPlaceholder.style.display = 'flex';
                    
                    status.textContent = '‚è∏Ô∏è DETENIDO';
                    status.className = 'status stopped';
                    
                    detectedLetter.textContent = '-';
                    confidence.textContent = '0';
                    
                    updateActiveLetter(null);
                    
                    if (detectionInterval) {
                        clearInterval(detectionInterval);
                    }
                    
                } else {
                    alert('Error al detener detecci√≥n: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Actualizar detecci√≥n
        // Funci√≥n optimizada de detecci√≥n con frame skipping y throttling
        async function updateDetection() {
            if (!isDetecting) return;
            
            // Implementar frame skipping para mejor rendimiento
            frameSkipCounter++;
            if (frameSkipCounter < frameSkipRate) {
                return;
            }
            frameSkipCounter = 0;
            
            // Throttling de actualizaciones UI
            const currentTime = Date.now();
            if (currentTime - lastUpdateTime < updateThrottle) {
                return;
            }
            lastUpdateTime = currentTime;
            
            try {
                const response = await fetch('/detection-data/');
                const data = await response.json();
                
                if (data.status === 'running' && data.frame) {
                    // Optimizaci√≥n: solo actualizar imagen si es necesaria
                    if (data.frame !== lastKnownFrame) {
                        videoFeed.src = 'data:image/jpeg;base64,' + data.frame;
                        lastKnownFrame = data.frame;
                    }
                    
                    // Optimizaci√≥n: solo actualizar UI si los datos cambiaron
                    if (data.letter !== lastKnownPrediction) {
                        detectedLetter.textContent = data.letter || 'NINGUNA';
                        lastKnownPrediction = data.letter;
                        updateActiveLetter(data.letter);
                    }
                    
                    confidence.textContent = data.confidence || 0;
                    
                    if (data.letter && data.letter !== 'NINGUNA') {
                        detectionCount++;
                        detectionCountEl.textContent = detectionCount;
                    }
                    
                    // Actualizar informaci√≥n de entrenamiento de forma eficiente
                    if (isTraining && data.training) {
                        // Batch update para evitar reflows m√∫ltiples
                        requestAnimationFrame(() => {
                            targetLetterEl.textContent = data.training.target_letter;
                            trainingCorrect.textContent = data.training.correct_detections;
                            trainingTotal.textContent = data.training.total_attempts;
                            trainingAccuracy.textContent = data.training.accuracy;
                            trainingConsecutive.textContent = data.training.consecutive_correct;
                        });
                    }
                    
                    // Mostrar resultado de entrenamiento con animaciones optimizadas
                    if (data.training_result) {
                        if (data.training_result.success) {
                            trainingMessage.textContent = data.training_result.message;
                            trainingMessage.className = 'training-message success';
                            
                            // Usar requestAnimationFrame para animaciones suaves
                            setTimeout(() => {
                                requestAnimationFrame(() => {
                                    targetLetterEl.textContent = data.training_result.next_letter;
                                    updateReferenceImage(data.training_result.next_letter);
                                    trainingMessage.textContent = `¬°Ahora haz la letra "${data.training_result.next_letter}"!`;
                                    trainingMessage.className = 'training-message hint';
                                });
                            }, REFERENCE_CONFIG.ui.animationDuration);
                            
                        } else if (data.training_result.message) {
                            trainingMessage.textContent = data.training_result.message;
                            trainingMessage.className = 'training-message hint';
                        }
                    }
                    
                    fpsCounter++;
                    
                } else if (data.status === 'error') {
                    console.error('Error en detecci√≥n:', data.message);
                }
                
            } catch (error) {
                console.error('Error updating detection:', error);
            }
        }

        // Actualizar FPS cada segundo
        setInterval(() => {
            fpsEl.textContent = fpsCounter;
            fpsCounter = 0;
        }, 1000);

        // Funciones de diagn√≥stico
        async function testCamera() {
            try {
                testCameraBtn.disabled = true;
                testCameraBtn.textContent = 'üîç Probando...';
                
                const response = await fetch('/test-camera/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(`‚úÖ C√°mara encontrada en √≠ndice ${data.camera_index}`);
                } else {
                    alert(`‚ùå Error: ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            } finally {
                testCameraBtn.disabled = false;
                testCameraBtn.textContent = 'üîç Probar C√°mara';
            }
        }

        async function testModel() {
            try {
                testModelBtn.disabled = true;
                testModelBtn.textContent = 'ü§ñ Probando...';
                
                const response = await fetch('/test-model/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    const info = data.model_info;
                    alert(`‚úÖ Modelo OK\n- Cargado: ${info.model_loaded}\n- Clases: ${info.class_names_count}\n- Ejecut√°ndose: ${info.is_running}`);
                } else {
                    alert(`‚ùå Error del modelo: ${data.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            } finally {
                testModelBtn.disabled = false;
                testModelBtn.textContent = 'ü§ñ Probar Modelo';
            }
        }

        // Funciones de entrenamiento
        async function startTraining() {
            try {
                trainingBtn.disabled = true;
                trainingBtn.textContent = 'üéì Iniciando...';
                
                const response = await fetch('/start-training/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    isTraining = true;
                    trainingSection.style.display = 'block';
                    trainingBtn.style.display = 'none';
                    stopTrainingBtn.style.display = 'inline-block';
                    
                    targetLetterEl.textContent = data.target_letter;
                    updateReferenceImage(data.target_letter); // ‚Üê Actualizar imagen de referencia
                    trainingMessage.textContent = `¬°Haz la letra "${data.target_letter}" con tu mano!`;
                    trainingMessage.className = 'training-message hint';
                    
                } else {
                    alert('‚ùå Error iniciando entrenamiento: ' + data.message);
                    trainingBtn.disabled = false;
                    trainingBtn.textContent = 'üéì Modo Entrenamiento';
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n: ' + error.message);
                trainingBtn.disabled = false;
                trainingBtn.textContent = 'üéì Modo Entrenamiento';
            }
        }

        async function stopTraining() {
            try {
                const response = await fetch('/stop-training/', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    isTraining = false;
                    trainingSection.style.display = 'none';
                    trainingBtn.style.display = 'inline-block';
                    stopTrainingBtn.style.display = 'none';
                    trainingBtn.disabled = false;
                    trainingBtn.textContent = 'üéì Modo Entrenamiento';
                    
                    if (data.final_stats) {
                        alert(`üéì Entrenamiento terminado!\n\nEstad√≠sticas finales:\n- Aciertos: ${data.final_stats.correct_detections}/${data.final_stats.total_attempts}\n- Precisi√≥n: ${data.final_stats.accuracy}%\n- Consecutivos: ${data.final_stats.consecutive_correct}`);
                    }
                }
            } catch (error) {
                alert('‚ùå Error deteniendo entrenamiento: ' + error.message);
            }
        }

        // Event listeners
        toggleBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
        trainingBtn.addEventListener('click', startTraining);
        stopTrainingBtn.addEventListener('click', stopTraining);
        testCameraBtn.addEventListener('click', testCamera);
        testModelBtn.addEventListener('click', testModel);

        // Inicializar
        createAlphabetGrid();
    </script>
</body>
</html>
